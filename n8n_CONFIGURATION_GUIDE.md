# n8n Configuration Guide - User ID Integration

## üéØ Overview

This guide shows you exactly how to update your n8n workflows to work with the new multi-user system.

---

## üìù Workflow 1: Logger Workflow (Recurring Research Handler)

### Current Flow:
```
Webhook ‚Üí Code (Generate IDs) ‚Üí Supabase Insert ‚Üí First Time Runner
```

### ‚úÖ Your Code Node is Already Ready!

Your existing JavaScript code already validates `userId`:

```javascript
const crypto = require('crypto');

return items.map(item => {
  const webhookData = item.json.body || item.json;
  const now = new Date();
  
  // ===== CRITICAL: VALIDATE USER ID =====
  if (!webhookData.userId) {
    throw new Error('SECURITY ERROR: userId is required but missing from webhook payload');
  }
  
  // ===== GENERATE UNIQUE IDs =====
  const scheduleId = `sched_${crypto.randomUUID()}`;
  const executionId = `exec_${Date.now()}_${scheduleId.substring(6, 16)}`;
  
  // ===== CALCULATE NEXT RUN DATE =====
  const calculateNextRun = (frequency) => {
    const intervals = {
      'daily': 1,
      'weekly': 7,
      'biweekly': 14,
      'monthly': 30
    };
    const days = intervals[frequency.toLowerCase()] || 7;
    const nextRun = new Date(now);
    nextRun.setDate(nextRun.getDate() + days);
    return nextRun.toISOString();
  };
  
  // ===== PREPARE DATA FOR SUPABASE =====
  return {
    json: {
      // USER TRACKING (CRITICAL)
      user_id: webhookData.userId,           // ‚úÖ Now being sent!
      user_email: webhookData.userEmail,     // ‚úÖ Now being sent!
      
      // SCHEDULE IDENTIFIERS
      schedule_id: scheduleId,
      execution_id: executionId,
      
      // SCHEDULE CONFIGURATION
      title: `${webhookData.marketCategory} - ${webhookData.subNiche}`,
      industry: webhookData.marketCategory,
      sub_niche: webhookData.subNiche,
      geography: webhookData.geography || 'Global',
      email: webhookData.email,
      frequency: webhookData.frequency.toLowerCase(),
      notes: webhookData.notes || '',
      
      // SCHEDULE STATE
      status: 'active',
      active: true,
      next_run: calculateNextRun(webhookData.frequency),
      created_at: now.toISOString(),
      last_run: null,
      execution_count: 0,
      
      // EXECUTION FLAGS
      is_first_run: true,
      show_immediately: true,
      research_type: 'recurring',
      
      // DEBUG INFO
      workflow_triggered_at: now.toISOString()
    }
  };
});
```

**‚úÖ No changes needed to this code!**

---

### üìä Supabase Insert Node Configuration

**Node Name**: "Insert Schedule to Supabase"

#### Settings:
- **Resource**: Insert
- **Table**: `schedules`

#### Column Mappings:

| Column | Expression | Notes |
|--------|-----------|-------|
| `user_id` | `{{ $json.user_id }}` | ‚ö†Ô∏è **CRITICAL** - Must be set |
| `schedule_id` | `{{ $json.schedule_id }}` | Generated by Code node |
| `execution_id` | `{{ $json.execution_id }}` | For first run |
| `title` | `{{ $json.title }}` | Display name |
| `industry` | `{{ $json.industry }}` | Market category |
| `sub_niche` | `{{ $json.sub_niche }}` | Specific focus |
| `geography` | `{{ $json.geography }}` | Location |
| `email` | `{{ $json.email }}` | User's email |
| `frequency` | `{{ $json.frequency }}` | daily/weekly/biweekly/monthly |
| `notes` | `{{ $json.notes }}` | Optional notes |
| `status` | `{{ $json.status }}` | 'active' |
| `active` | `{{ $json.active }}` | true |
| `next_run` | `{{ $json.next_run }}` | ISO timestamp |
| `created_at` | `{{ $json.created_at }}` | ISO timestamp |
| `last_run` | `{{ $json.last_run }}` | null initially |
| `execution_count` | `{{ $json.execution_count }}` | 0 initially |

---

## üìù Workflow 2: First Time Runner Workflow

### Current Flow:
```
Webhook (from Logger) ‚Üí Process Report ‚Üí HTTP Request (to /api/report-run)
```

### üîß HTTP Request Node Configuration

**Node Name**: "Send Report to API"

#### Settings:
- **Method**: POST
- **URL**: `https://quantitva.vercel.app/api/report-run`
- **Authentication**: None
- **Send Body**: true
- **Content Type**: JSON

#### JSON Body:

```json
{
  "schedule_id": "{{ $json.schedule_id }}",
  "user_id": "{{ $json.user_id }}",
  "industry": "{{ $json.industry }}",
  "sub_niche": "{{ $json.sub_niche }}",
  "frequency": "{{ $json.frequency }}",
  "run_at": "{{ $json.run_at }}",
  "is_first_run": {{ $json.is_first_run }},
  "final_report": {{ JSON.stringify($json.final_report) }}
}
```

**‚ö†Ô∏è CRITICAL**: Make sure `user_id` is included!

---

## üìù Workflow 3: Runner Workflow (Daily Scheduled)

### Current Flow:
```
Schedule Trigger ‚Üí Supabase Query (Get Due Schedules) ‚Üí Process ‚Üí HTTP Request
```

### üîß Supabase Query Node Configuration

**Node Name**: "Get Due Schedules"

#### Settings:
- **Resource**: Select
- **Table**: Use the `due_schedules_v2` view
- **Return All**: true

**The view automatically filters**:
- Only active schedules (`status = 'active'`)
- Only schedules that are due (`next_run <= NOW()`)
- Only schedules not currently running (`is_running = false`)

---

### üîß HTTP Request Node Configuration

**Node Name**: "Send Report to API"

#### JSON Body:

```json
{
  "schedule_id": "{{ $json.schedule_id }}",
  "user_id": "{{ $json.user_id }}",
  "industry": "{{ $json.industry }}",
  "sub_niche": "{{ $json.sub_niche }}",
  "frequency": "{{ $json.frequency }}",
  "run_at": "{{ $now() }}",
  "is_first_run": false,
  "final_report": {{ JSON.stringify($json.final_report) }}
}
```

**Note**: `is_first_run` should be `false` for recurring executions.

---

## üìù Workflow 4: On-Demand Research Workflow

### Current Flow:
```
Webhook ‚Üí Process Research ‚Üí Return Results
```

### ‚úÖ Webhook Node Configuration

The webhook now receives:

```json
{
  "userId": "uuid-here",
  "userEmail": "user@example.com",
  "marketCategory": "Technology & Software",
  "subNiche": "AI Automation",
  "geography": "usa",
  "email": "user@example.com",
  "notes": "...",
  "researchType": "on-demand"
}
```

**‚úÖ No changes needed!** The `userId` is automatically sent by the frontend.

---

## üß™ Testing Your Workflows

### Test 1: Logger Workflow
1. Go to your recurring research form
2. Fill it out and submit
3. Check n8n execution log
4. Verify `userId` and `userEmail` are in the webhook payload
5. Check Supabase `schedules` table - verify `user_id` column is populated

### Test 2: First Time Runner
1. After Logger workflow completes
2. Check First Time Runner execution
3. Verify HTTP request includes `user_id`
4. Check Supabase `reports` table - verify `user_id` is set

### Test 3: Runner Workflow (Scheduled)
1. Wait for scheduled execution (or trigger manually)
2. Verify it reads from `due_schedules_v2` view
3. Verify `user_id` is included in API request
4. Check that reports are created with correct `user_id`

---

## ‚ùå Common Errors & Fixes

### Error: "userId is required but missing from webhook payload"

**Cause**: Frontend not sending userId

**Fix**: Make sure you've updated the frontend forms (already done!)

---

### Error: "user_id is required" from API

**Cause**: n8n HTTP request missing `user_id` field

**Fix**: Add `"user_id": "{{ $json.user_id }}"` to JSON body

---

### Error: "null value in column 'user_id'"

**Cause**: Supabase insert missing `user_id`

**Fix**: Add `user_id` mapping in Supabase Insert node

---

## üìä Data Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User Browser   ‚îÇ
‚îÇ  (Logged In)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Submit Form
         ‚îú‚îÄ userId: "abc-123"
         ‚îî‚îÄ userEmail: "user@example.com"
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ n8n Logger      ‚îÇ
‚îÇ Webhook Node    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Validates userId
         ‚îÇ Generates schedule_id
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Supabase Insert ‚îÇ
‚îÇ schedules table ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Saves with user_id
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ First Runner    ‚îÇ
‚îÇ Processes Report‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Includes user_id
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API report-run  ‚îÇ
‚îÇ Validates user_id‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Saves to reports
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Supabase        ‚îÇ
‚îÇ reports table   ‚îÇ
‚îÇ (with user_id)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Verification Checklist

- [ ] Logger workflow Code node has userId validation
- [ ] Supabase Insert node maps `user_id` field
- [ ] First Time Runner HTTP request includes `user_id`
- [ ] Runner workflow query uses `due_schedules_v2` view
- [ ] Runner workflow HTTP request includes `user_id`
- [ ] Test with actual user login and form submission
- [ ] Verify `user_id` appears in Supabase tables
- [ ] Test with multiple users - verify data isolation

---

**Configuration Complete!** üéâ

Your n8n workflows are now ready for the multi-user system.

